<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Page d'accueil</title>
  <link rel="stylesheet" href="{{ asset('css/home/styles.css') }}">
  <!-- Bootstrap CSS (version 5) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <header>
    <h1>Bienvenue sur notre application Symfony</h1>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Accueil</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link" href="/about">Mes Anciennes Commandes</a></li>
            <li class="nav-item"><a class="nav-link" href="/contact">Contact</a></li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item">
              <!-- Bouton pour ouvrir le popup du panier -->
              <a class="nav-link" href="javascript:void(0)" data-bs-toggle="modal" data-bs-target="#cartModal">
                üõí
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>
  
  <main class="container mt-3">
    <section>
      <h1>Bonjour {{ app.session.get('user')['prenom'] ?? 'cher visiteur' }}</h1>
      <h2>Bienvenue dans l'Application du Fauteuil Rouge!</h2>
      <p>Ceci est la page d'accueil de l'appli.</p>
    </section>
    <section class="filtres">
      <div class="row mb-3">
        <div class="col-12 col-md-4 mb-2">
          <select id="categorySelect" class="form-select">
            <option value="">Toutes les cat√©gories</option>
            {% for category in categories %}
              <option value="{{ category.id }}">{{ category.libelle }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-4 mb-2" id="subcategoryCol" style="display: none;">
          <select id="subcategorySelect" class="form-select">
            <option value="">Toutes les sous-cat√©gories</option>
          </select>
        </div>
      </div>
    </section>

    <script>
    // Structure de donn√©es pour les sous-cat√©gories
    const categoriesData = {
      {% for category in categories %}
        {{ category.id }}: [
          {% if subcategoriesByCategory[category.id] is defined %}
            {% for subcategory in subcategoriesByCategory[category.id] %}
              { 
                id: {{ subcategory.id }}, 
                libelle: "{{ subcategory.libelle|e('js') }}" 
              },
            {% endfor %}
          {% endif %}
        ],
      {% endfor %}
    };

    // Gestion des √©v√©nements
    document.getElementById('categorySelect').addEventListener('change', function() {
      const categoryId = this.value;
      const subcategorySelect = document.getElementById('subcategorySelect');
      const subcategoryCol = document.getElementById('subcategoryCol');
      
      subcategorySelect.innerHTML = '<option value="">Toutes les sous-cat√©gories</option>';
      subcategoryCol.style.display = 'none';

      if (categoryId && categoriesData[categoryId]?.length > 0) {
        categoriesData[categoryId].forEach(sub => {
          const option = new Option(sub.libelle, sub.id);
          subcategorySelect.add(option);
        });
        subcategoryCol.style.display = 'block';
      }
      
      filterProducts();
    });

    document.getElementById('subcategorySelect').addEventListener('change', filterProducts);

    function filterProducts() {
      const selectedCategory = document.getElementById('categorySelect').value;
      const selectedSubcategory = document.getElementById('subcategorySelect').value;

      document.querySelectorAll('.produit-cadre').forEach(product => {
        const productCategory = product.dataset.category;
        const productSubcategory = product.dataset.subcategory || '';
        
        const categoryMatch = !selectedCategory || (productCategory === selectedCategory);
        const subcategoryMatch = !selectedSubcategory || (productSubcategory === selectedSubcategory);
        
        product.style.display = (categoryMatch && subcategoryMatch) ? 'block' : 'none';
      });
    }
    </script>
    <section class="boutique">
        <h2>Nos Produits</h2>
        <div class="produits-liste">
          {% for produit in produits %}
            <div class="produit-cadre" 
                data-category="{{ produit.categorie.id }}"
                data-subcategory="{{ produit.sousCategorie ? produit.sousCategorie.id : '' }}">
                    <img src="{{ produit.refProduit }}" alt="{{ produit.nom }}" class="produit-image">
                    <h3 id="nom-{{ produit.id }}" class="produit-nom">{{ produit.nom }}</h3>

                    {% if produit.prix is not null %}
                        <p class="produit-prix">Prix: {{ produit.prix }} ‚Ç¨</p>
                    {% else %}
                        {% set nbTailles = produit.avoirs|length %}
                        {% if nbTailles == 1 %}
                            {% set seuleTaille = produit.avoirs|first %}
                            <p class="produit-prix">Taille : {{ seuleTaille.taille.unite }} - {{ seuleTaille.prix }} ‚Ç¨</p>
                        {% else %}
                            <label for="taille-{{ produit.id }}">Taille :</label>
                            <select id="taille-{{ produit.id }}" class="taille-select form-select">
                                {% for avoir in produit.avoirs %}
                                    <option value="{{ avoir.taille.unite }}">{{ avoir.taille.unite }} - {{ avoir.prix }} ‚Ç¨</option>
                                {% endfor %}
                            </select>
                        {% endif %}
                    {% endif %}
                        <div class="quantity-wrapper">
                            <label for="quantite-{{ produit.id }}">Quantit√© :</label>
                            <div class="input-group" style="width: 150px;">
                                <button type="button" class="btn btn-secondary" onclick="updateQuantity('{{ produit.id }}', -1)">-</button>
                                <input type="number" id="quantite-{{ produit.id }}" value="1" min="1" max="10" class="form-control text-center">
                                <button type="button" class="btn btn-secondary" onclick="updateQuantity('{{ produit.id }}', 1)">+</button>
                            </div>
                        </div>
                    <!-- Bouton d'ajout qui ouvre le modal de confirmation -->
                    <button class="produit-bouton btn btn-primary" onclick="openConfirmModal({{ produit.id }})">
                        Ajouter au panier
                    </button>
                </div>
            {% endfor %}

            </div>
        </section>
  </main>

  <!-- Modal de confirmation pour l'ajout au panier -->
  <div class="modal fade" id="confirmAddModal" tabindex="-1" aria-labelledby="confirmAddModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmAddModalLabel">Confirmation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          √ätes-vous s√ªr d'ajouter ce produit au panier ?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="confirmAddButton">Confirmer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal du panier (popup r√©capitulatif) -->
  <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cartModalLabel">Votre Panier</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body" id="cartContent">
          <p id="emptyCartMsg">Votre panier est vide.</p>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal d'erreur -->
  <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="errorModalLabel">Erreur</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <p id="errorMessage">Vous ne pouvez pas commander plus de 10 fois le m√™me article !</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
</div>


  <!-- Bootstrap JS Bundle (inclut Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let currentProduitId = null;

    function openConfirmModal(produitId) {
        currentProduitId = produitId;
        let confirmModal = new bootstrap.Modal(document.getElementById('confirmAddModal'));
        confirmModal.show();
    }

    document.getElementById('confirmAddButton').addEventListener('click', function() {
        ajouterAuPanierConfirmed(currentProduitId);
        bootstrap.Modal.getInstance(document.getElementById('confirmAddModal')).hide();
    });

    function ajouterAuPanierConfirmed(produitId) {
        const quantiteInput = document.getElementById('quantite-' + produitId);
        const quantite = parseInt(quantiteInput.value);
        const tailleElement = document.getElementById('taille-' + produitId);
        const taille = tailleElement ? tailleElement.value : "unique";
        const itemId = `panier-${produitId}-${taille}`;

        const existingItem = document.getElementById(itemId);
        let quantiteExistante = 0;
        if (existingItem) {
            quantiteExistante = parseInt(existingItem.querySelector('.panier-quantite').textContent);
        }

        if (quantiteExistante + quantite > 10) {
            showErrorPopup("Vous ne pouvez pas commander plus de 10 fois le m√™me article !");
            quantiteInput.value = 10 - quantiteExistante;
            return;
        }
        if (quantite > 0) {
            const cartItem = document.getElementById(itemId);
            if (cartItem) {
                // Mise √† jour de la quantit√© existante
                const span = cartItem.querySelector('.panier-quantite');
                span.textContent = parseInt(span.textContent) + parseInt(quantite);
            } else {
                // Cr√©ation d'un nouvel √©l√©ment dans le panier
                const cartContent = document.getElementById('cartContent');
                if (document.getElementById('emptyCartMsg')) cartContent.innerHTML = '';

                cartContent.innerHTML += `
                    <div id="${itemId}" class="d-flex justify-content-between mb-2">
                        <span>${document.getElementById('nom-' + produitId).textContent} (${taille})</span>
                        <div>
                            <button class="btn btn-sm btn-secondary" onclick="modifierQuantite('${produitId}', '${taille}', -1)">-</button>
                            <span class="panier-quantite mx-2">${quantite}</span>
                            <button class="btn btn-sm btn-secondary" onclick="modifierQuantite('${produitId}', '${taille}', 1)">+</button>
                            <button class="btn btn-sm btn-danger" onclick="retirerProduit('${produitId}', '${taille}')">‚ùå</button>
                        </div>
                    </div>
                `;
            }
        }
    }

     function modifierQuantite(produitId, taille, change) {
        const itemId = `panier-${produitId}-${taille}`;
        const span = document.querySelector(`#${itemId} .panier-quantite`);
        let nouvelleQuantite = parseInt(span.textContent) + change;

        // Bloque si on d√©passe 10 en augmentation
        if (change === 1 && nouvelleQuantite > 10) {
            alert("Quantit√© maximale (10) atteinte pour cet article !");
            return;
        }
        if (nouvelleQuantite <= 0) retirerProduit(produitId, taille);
        else span.textContent = nouvelleQuantite;
    }

    function retirerProduit(produitId, taille) {
        if (!confirm("Confirmer la suppression ?")) return;
        const itemId = `panier-${produitId}-${taille}`;
        document.getElementById(itemId).remove();
        if (!document.getElementById('cartContent').children.length) {
            document.getElementById('cartContent').innerHTML = '<p id="emptyCartMsg">Votre panier est vide.</p>';
        }
    }
    function showErrorPopup(message) {
        document.getElementById('errorMessage').textContent = message;
        let errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        errorModal.show();
    }


    function updateQuantity(produitId, change) {
        const input = document.getElementById('quantite-' + produitId);
        let value = parseInt(input.value) + change;
            
        // Bloque √† 10 directement sur l'input
        if (value > 10) {
          alert("Vous ne pouvez pas s√©lectionner plus de 10 articles !");
          value = 10;
        }
            
        input.value = Math.max(1, Math.min(10, value));
    }
  </script>

</body>
</html>














