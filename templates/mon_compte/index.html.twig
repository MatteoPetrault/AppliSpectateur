{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/mon_compte/styles.css') }}">
{% endblock %}

{% block content %}
<div class="compte-container">
    <h2>Modifier mon compte</h2>
    
    <form method="post" id="updateForm">
        <input type="hidden" name="action" value="update">
        
        <div class="form-group">
            <label>Nom</label>
            <input type="text" name="nom" value="{{ client.nom }}" class="form-control" required>
        </div>
        
        <div class="form-group">
            <label>Prénom</label>
            <input type="text" name="prenom" value="{{ client.prenom }}" class="form-control" required>
        </div>
        
        <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" value="{{ client.email }}" class="form-control" required>
        </div>
        
        <div class="form-group">
            <label>Login</label>
            <input type="text" name="login" value="{{ client.login }}" class="form-control" required>
        </div>

        <div class="form-group">
            <label>Ancien mot de passe *</label>
            <input type="password" name="old_password" class="form-control" required>
        </div>

        <button type="button" id="togglePasswordChange" class="btn btn-secondary mb-3">Modifier mon mot de passe</button>

        <div class="password-change" style="display:none;">
            <div class="form-group">
                <label>Nouveau mot de passe</label>
                <input type="password" name="new_password" class="form-control">
            </div>

            <div class="form-group">
                <label>Confirmation du nouveau mot de passe</label>
                <input type="password" name="confirm_password" class="form-control">
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Mettre à jour</button>
    </form>

    <form action="{{ path('supprimer_compte') }}" method="post" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer votre compte ?');">
        <button type="submit" class="btn btn-supprimer">Supprimer mon compte</button>
    </form>

    <div id="messageContainer"></div>
</div>

<script>
document.getElementById('togglePasswordChange').addEventListener('click', function() {
    document.querySelectorAll('.password-change').forEach(el => {
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    });
});

document.getElementById('updateForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const messageContainer = document.getElementById('messageContainer');
    messageContainer.innerHTML = '';

    try {
        const response = await fetch('{{ path('mon_compte') }}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();
        
        if (data.success) {
            messageContainer.innerHTML = `
                <div class="alert alert-success">
                    ${data.message}
                    <div class="mt-2">
                        <a href="{{ path('home') }}" class="btn btn-sm btn-success">Retour à la boutique</a>
                    </div>
                </div>
            `;
            this.reset();
        } else {
            let errorHTML = `<div class="alert alert-danger">${data.message}</div>`;
            if (data.errors) {
                errorHTML += data.errors.map(error => `
                    <div class="text-danger mt-2">${error.message}</div>
                `).join('');
            }
            messageContainer.innerHTML = errorHTML;
        }
    } catch (error) {
        console.error('Erreur:', error);
        messageContainer.innerHTML = `<div class="alert alert-danger">Une erreur inattendue est survenue</div>`;
    }
});
</script>
{% endblock %}