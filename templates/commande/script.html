<script>
    // DÃ©finition de la map des statuts pour l'interface
    const statusMap = {
        'En cours de prÃ©paration': { 
            progress: 15, 
            step: 1, 
            emoji: 'ğŸ¿',
            message: 'PrÃ©paration de vos produits en cours'
        },
        'En attente de rÃ©cupÃ©ration': { 
            progress: 50, 
            step: 2, 
            emoji: 'ğŸ¬',
            message: 'Votre commande est prÃªte !'
        },
        'TerminÃ©': { 
            progress: 100, 
            step: 3, 
            emoji: 'ğŸ‰',
            message: 'Bon film ! ğŸ¥'
        },
        'AnnulÃ©': { 
            progress: 0, 
            step: 0, 
            emoji: 'âŒ',
            message: 'Commande annulÃ©e'
        }
    };

    // Fonction updateInterface qui met Ã  jour l'interface en fonction du statut retournÃ©
    function updateInterface(data) {
        // Normalisation du statut pour l'affichage
        const normalizedStatus = data.statut === 'EnregistrÃ©e' 
            ? 'En cours de prÃ©paration' 
            : data.statut;
        
        const statusInfo = statusMap[normalizedStatus] || { 
            progress: 0, 
            step: 0, 
            emoji: 'â“',
            message: 'Statut inconnu'
        };

        // Mise Ã  jour de la barre de progression
        document.getElementById('progress').style.width = statusInfo.progress + '%';

        // Mise Ã  jour des Ã©tapes visuelles
        document.querySelectorAll('.status-step').forEach((step, index) => {
            const isActive = index < statusInfo.step;
            const isCurrent = index + 1 === statusInfo.step;
            step.classList.toggle('active-step', isActive);
            step.querySelector('.step-icon').classList.toggle('pulse', isCurrent);
        });

        // Affichage du message de statut
        document.getElementById('statusMessage').innerHTML = 
            `${statusInfo.emoji} ${statusInfo.message}`;

        // Mise Ã  jour de la notification de paiement pour le statut "En attente de rÃ©cupÃ©ration"
        const paymentNotice = document.getElementById('paymentNotice');
        paymentNotice.innerHTML = (normalizedStatus === 'En attente de rÃ©cupÃ©ration') ? `
            <div class="client-info">
                Nom : ${data.nom}<br>
                PrÃ©nom : ${data.prenom}<br>
                NumÃ©ro de commande : ${data.numero_commande}
            </div>
            <div class="payment-notice">
                <strong>ğŸš¨ Votre commande est prÃªte !</strong><br>
                Merci de venir la rÃ©cupÃ©rer et rÃ©gler au comptoir.
            </div>
        ` : '';

        // ContrÃ´le de la visibilitÃ© du bouton d'annulation selon le statut rÃ©el
        const cancelButton = document.getElementById('cancelButton');
        if (cancelButton) {
            cancelButton.style.display = (data.statut === 'EnregistrÃ©e') ? 'block' : 'none';
        }
    }


    // RafraÃ®chissement de l'interface toutes les 10 secondes
    setInterval(() => {
        fetch("{{ path('commande_statut', {'id': commande.id}) }}")
            .then(response => response.json())
            .then(data => updateInterface(data))
            .catch(error => {
                console.error('Erreur:', error);
                document.getElementById('statusMessage').innerHTML = 'âš ï¸ ProblÃ¨me de connexion';
            });
    }, 10000);

    // Mise Ã  jour initiale de l'interface avec les donnÃ©es de Twig
    updateInterface({ 
        statut: "{{ statut }}", 
        nom: "", 
        prenom: "", 
        numero_commande: "{{ commande.id }}" 
    });

    // Gestion de l'annulation de la commande en AJAX
    const cancelButton = document.getElementById('cancelButton');
    if (cancelButton) {
        cancelButton.addEventListener('click', function() {
            if (confirm('ÃŠtes-vous sÃ»r de vouloir annuler la commande ?')) {
                fetch("{{ path('commande_annuler', {'id': commande.id}) }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Mettre Ã  jour l'interface avec le nouveau statut "AnnulÃ©"
                        updateInterface({ 
                            statut: data.statut, 
                            nom: "", 
                            prenom: "", 
                            numero_commande: "{{ commande.id }}" 
                        });
                        // Masquer le bouton d'annulation
                        cancelButton.style.display = 'none';
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert("Une erreur s'est produite lors de l'annulation.");
                });
            }
        });
    }

    let currentRating = 0;
    function rate(rating) {
        currentRating = rating;
        const stars = document.querySelectorAll('.star-rating span');
        stars.forEach((star, index) => {
            star.style.color = index < rating ? '#ffcc00' : '#ccc';
        });
    }

    function submitFeedback() {
        const comment = document.getElementById('comment').value;
        if (currentRating > 0) {
            const feedbackData = {
                note: currentRating,
                commentaire: comment
            };

            fetch("{{ path('enregistrer_avis', {'id': commande.id}) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(feedbackData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Merci pour votre avis !");
                    document.getElementById('feedbackSection').style.display = 'none';
                } else {
                    alert(data.message);
                    if (data.message === 'Un avis a dÃ©jÃ  Ã©tÃ© soumis pour cette commande.') {
                        document.getElementById('feedbackSection').style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert("Une erreur s'est produite lors de l'envoi de votre avis.");
            });
        } else {
            alert("Veuillez donner une note avant de soumettre.");
        }
    }

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const button = document.getElementById('darkModeToggle');
        button.textContent = document.body.classList.contains('dark-mode')
            ? 'Mode LumiÃ¨re â˜€ï¸'
            : 'Mode CinÃ©ma ğŸ¥';
    }
</script>
